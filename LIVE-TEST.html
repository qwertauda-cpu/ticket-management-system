<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            margin: 5px 0;
            transition: all 0.3s;
            font-family: 'Cairo', Arial, sans-serif;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-right: 4px solid #667eea;
        }
        .result.success {
            border-right-color: #10b981;
            background: #f0fdf4;
        }
        .result.error {
            border-right-color: #ef4444;
            background: #fef2f2;
        }
        .result h4 {
            margin-bottom: 10px;
            color: #333;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin: 5px;
        }
        .status-scheduled { background: #dbeafe; color: #1e40af; }
        .status-assigned { background: #fef3c7; color: #92400e; }
        .status-in-progress { background: #d1fae5; color: #065f46; }
        .status-paused { background: #fed7aa; color: #9a3412; }
        .status-pending-qa { background: #e0e7ff; color: #3730a3; }
        .status-done { background: #d1fae5; color: #065f46; }
        .info-box {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .info-box h3 {
            color: #0369a1;
            margin-bottom: 10px;
        }
        #results {
            margin-top: 30px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</h1>
            <p>Ø§Ø®ØªØ¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¶ØºØ·Ø© Ø²Ø±!</p>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹:</h3>
            <p><strong>Frontend:</strong> <a href="http://localhost:5173" target="_blank">http://localhost:5173</a></p>
            <p><strong>Backend:</strong> http://localhost:3000</p>
            <p><strong>Email:</strong> owner@example.com</p>
            <p><strong>Password:</strong> password123</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>1ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                <button onclick="testLogin()">ğŸ” Login</button>
                <div id="login-status"></div>
            </div>

            <div class="card">
                <h3>2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <button onclick="createNewTicket()" id="create-btn" disabled>â• Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø©</button>
                <div id="create-status"></div>
            </div>

            <div class="card">
                <h3>3ï¸âƒ£ Ø¯ÙˆØ±Ø© Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h3>
                <button onclick="testFullLifecycle()" id="lifecycle-btn" disabled>ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± ÙƒØ§Ù…Ù„</button>
                <div id="lifecycle-status"></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                <button onclick="testAssign()" id="assign-btn" disabled>ğŸ‘¤ ØªØ¹ÙŠÙŠÙ†</button>
                <button onclick="testStart()" id="start-btn" disabled>â–¶ï¸ Ø¨Ø¯Ø¡</button>
                <button onclick="testPause()" id="pause-btn" disabled>â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                <button onclick="testResume()" id="resume-btn" disabled>â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
                <button onclick="testFinish()" id="finish-btn" disabled>â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>

            <div class="card">
                <h3>âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© (QA)</h3>
                <button onclick="testQAApprove()" id="qa-approve-btn" disabled>âœ… Ù‚Ø¨ÙˆÙ„</button>
                <button onclick="testQAReject()" id="qa-reject-btn" disabled>âŒ Ø±ÙØ¶</button>
            </div>

            <div class="card">
                <h3>ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <button onclick="getTickets()" id="list-btn" disabled>ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªØ°Ø§ÙƒØ±</button>
                <button onclick="getTicketDetails()" id="details-btn" disabled>ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let token = null;
        let currentTicketId = null;

        function addResult(title, success, data, containerId = 'results') {
            const div = document.createElement('div');
            div.className = `result ${success ? 'success' : 'error'}`;
            div.innerHTML = `
                <h4>${success ? 'âœ…' : 'âŒ'} ${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            document.getElementById(containerId).appendChild(div);
            document.getElementById(containerId).scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function updateButtons(enabled) {
            ['create-btn', 'lifecycle-btn', 'list-btn', 'details-btn', 'assign-btn', 'start-btn', 
             'pause-btn', 'resume-btn', 'finish-btn', 'qa-approve-btn', 'qa-reject-btn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = !enabled;
            });
        }

        async function testLogin() {
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'owner@example.com',
                        password: 'password123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.accessToken) {
                    token = data.accessToken;
                    document.getElementById('login-status').innerHTML = 
                        '<div class="status-badge status-done">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>';
                    updateButtons(true);
                    addResult('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', true, {
                        user: data.user.name,
                        email: data.user.email,
                        isOwner: data.user.isOwner,
                        permissions: data.user.permissions
                    });
                } else {
                    addResult('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', false, data);
                }
            } catch (error) {
                addResult('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', false, { error: error.message });
            }
        }

        async function createNewTicket() {
            if (!token) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/tickets`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ticketType: 'FTTH_NEW',
                        phone: '07701234567',
                        zone: 'Baghdad - Test',
                        description: 'ØªØ°ÙƒØ±Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©',
                        isNationalSla: false,
                        action: 'schedule',
                        scheduledAt: new Date(Date.now() + 86400000).toISOString()
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentTicketId = data.id;
                    document.getElementById('create-status').innerHTML = 
                        `<div class="status-badge status-scheduled">ğŸ“‹ ${data.ticketNumber}</div>`;
                    addResult('Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©', true, {
                        ticketNumber: data.ticketNumber,
                        status: data.status,
                        phone: data.phone,
                        zone: data.zone
                    });
                } else {
                    addResult('Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø©', false, data);
                }
            } catch (error) {
                addResult('Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø©', false, { error: error.message });
            }
        }

        async function testFullLifecycle() {
            if (!token) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }

            // Create new ticket first
            await createNewTicket();
            await new Promise(resolve => setTimeout(resolve, 1000));

            const actions = [
                { name: 'ØªØ¹ÙŠÙŠÙ†', fn: testAssign },
                { name: 'Ø¨Ø¯Ø¡', fn: testStart },
                { name: 'Ø¥ÙŠÙ‚Ø§Ù', fn: testPause },
                { name: 'Ø§Ø³ØªØ¦Ù†Ø§Ù', fn: testResume },
                { name: 'Ø¥Ù†Ù‡Ø§Ø¡', fn: testFinish },
                { name: 'Ù‚Ø¨ÙˆÙ„ QA', fn: testQAApprove }
            ];

            for (const action of actions) {
                await action.fn();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            document.getElementById('lifecycle-status').innerHTML = 
                '<div class="status-badge status-done">âœ… Ø§ÙƒØªÙ…Ù„Øª Ø¯ÙˆØ±Ø© Ø§Ù„Ø­ÙŠØ§Ø©</div>';
        }

        async function testAssign() {
            if (!currentTicketId) {
                alert('ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ ØªØ°ÙƒØ±Ø© Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/assign`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assigneeType: 'technician',
                        assigneeId: 'tech-web-test'
                    })
                });

                const data = await response.json();
                addResult('ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ°ÙƒØ±Ø©', response.ok, {
                    status: data.status,
                    assigneeType: data.assigneeType,
                    assigneeId: data.assigneeId
                });
            } catch (error) {
                addResult('ØªØ¹ÙŠÙŠÙ†', false, { error: error.message });
            }
        }

        async function testStart() {
            if (!currentTicketId) return;
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/start`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                addResult('Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„', response.ok, { status: data.status, startedAt: data.startedAt });
            } catch (error) {
                addResult('Ø¨Ø¯Ø¡', false, { error: error.message });
            }
        }

        async function testPause() {
            if (!currentTicketId) return;
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/pause`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                addResult('Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª', response.ok, { status: data.status });
            } catch (error) {
                addResult('Ø¥ÙŠÙ‚Ø§Ù', false, { error: error.message });
            }
        }

        async function testResume() {
            if (!currentTicketId) return;
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/resume`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                addResult('Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¹Ù…Ù„', response.ok, { status: data.status });
            } catch (error) {
                addResult('Ø§Ø³ØªØ¦Ù†Ø§Ù', false, { error: error.message });
            }
        }

        async function testFinish() {
            if (!currentTicketId) return;
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/finish`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                addResult('Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„', response.ok, { status: data.status, finishedAt: data.finishedAt });
            } catch (error) {
                addResult('Ø¥Ù†Ù‡Ø§Ø¡', false, { error: error.message });
            }
        }

        async function testQAApprove() {
            if (!currentTicketId) return;
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/qa/approve`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ qaNotes: 'ØªÙ… Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ø®ØªØ¨Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ' })
                });
                const data = await response.json();
                addResult('Ù‚Ø¨ÙˆÙ„ QA', response.ok, { 
                    status: data.status, 
                    qaStatus: data.qaStatus,
                    qaNotes: data.qaNotes 
                });
            } catch (error) {
                addResult('Ù‚Ø¨ÙˆÙ„ QA', false, { error: error.message });
            }
        }

        async function testQAReject() {
            if (!currentTicketId) return;
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}/qa/reject`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ qaNotes: 'ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„ - Ø§Ø®ØªØ¨Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ' })
                });
                const data = await response.json();
                addResult('Ø±ÙØ¶ QA', response.ok, { 
                    status: data.status, 
                    qaStatus: data.qaStatus,
                    qaNotes: data.qaNotes 
                });
            } catch (error) {
                addResult('Ø±ÙØ¶ QA', false, { error: error.message });
            }
        }

        async function getTickets() {
            if (!token) return;
            try {
                const response = await fetch(`${API_URL}/tickets`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                addResult('Ø¹Ø±Ø¶ Ø§Ù„ØªØ°Ø§ÙƒØ±', response.ok, {
                    total: data.total,
                    count: data.items.length,
                    tickets: data.items.map(t => ({
                        ticketNumber: t.ticketNumber,
                        status: t.status,
                        phone: t.phone
                    }))
                });
            } catch (error) {
                addResult('Ø¹Ø±Ø¶ Ø§Ù„ØªØ°Ø§ÙƒØ±', false, { error: error.message });
            }
        }

        async function getTicketDetails() {
            if (!currentTicketId) {
                alert('ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± ØªØ°ÙƒØ±Ø© Ø£ÙˆÙ„Ø§Ù‹!');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/tickets/${currentTicketId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                addResult('ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©', response.ok, data);
            } catch (error) {
                addResult('ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©', false, { error: error.message });
            }
        }
    </script>
</body>
</html>

